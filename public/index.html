<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earn Pro - Elite Version</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0b0e11; --card: #1e2329; --yellow: #f0b90b; --green: #02c076; --red: #f84960; --text: #eaecef; --blue: #3262f1; --purple: #8a3ffc; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; height: 100vh; }
        
        .top-bar { width: 100%; background: var(--card); padding: 12px 15px; display: flex; justify-content: space-between; position: fixed; top: 0; z-index: 1000; border-bottom: 1px solid #333; box-sizing: border-box; }

        .game-area { height: 100vh; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden; }
        #multiplier { font-size: 85px; font-weight: 900; z-index: 20; text-shadow: 0 0 25px rgba(240,185,11,0.2); }
        #status { font-size: 18px; letter-spacing: 2px; color: var(--yellow); font-weight: bold; z-index: 20; }

        #p-cont { position: absolute; left: 10%; bottom: 30%; z-index: 50; display: none; }
        #p-img { font-size: 65px; transform: rotate(-10deg); filter: drop-shadow(0 0 15px white); }

        .controls { background: var(--card); width: 100%; padding: 20px; border-radius: 25px 25px 0 0; position: fixed; bottom: 0; z-index: 1000; box-sizing: border-box; border-top: 1px solid #444; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
        .input-box { width: 100%; padding: 15px; background: #2b3139; border: 2px solid #3a3f47; color: white; border-radius: 12px; margin-bottom: 12px; font-size: 18px; outline: none; transition: 0.3s; }
        .input-box:focus { border-color: var(--yellow); }

        .main-btn { width: 100%; padding: 18px; border: none; border-radius: 15px; font-weight: 800; font-size: 22px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-bet { background: linear-gradient(45deg, #02c076, #009e60); color: white; }
        .btn-cashout { background: linear-gradient(45deg, #f0b90b, #d4a008); color: black; display: none; }
        
        /* ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞‡¶´‡ßÅ‡¶≤ ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶¨‡¶æ‡¶ü‡¶® */
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .m-btn { border: none; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transition: 0.3s; }
        .m-dep { background: var(--blue); }
        .m-wit { background: var(--red); }
        .m-his { background: var(--purple); }
        .m-set { background: #474d57; }
        .m-btn:active { transform: scale(0.95); }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
        .pop-card { background: var(--card); width: 90%; padding: 25px; border-radius: 20px; border: 1px solid #444; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-pop { position: absolute; top: 10px; right: 15px; font-size: 25px; color: var(--red); cursor: pointer; }

        .smoke { position: absolute; width: 12px; height: 12px; background: rgba(255,255,255,0.2); border-radius: 50%; animation: sAnim 0.7s forwards; }
        @keyframes sAnim { to { transform: translate(-60px, 40px) scale(0); opacity: 0; } }
    </style>
</head>
<body>
    <div class="top-bar">
        <div style="font-weight: bold;">üë§ <span id="uName">Loading...</span></div>
        <div style="color:var(--yellow); font-weight: 800;">üí∞ <span id="uBalance">0</span></div>
    </div>

    <div class="game-area">
        <div id="multiplier">1.00x</div>
        <div id="status">INITIALIZING SYSTEM...</div>
        <div id="p-cont"><div id="p-img">‚úàÔ∏è</div></div>
    </div>

    <div class="controls">
        <input type="number" id="betAmt" class="input-box" placeholder="Bet Amount (Min 1)">
        <button class="main-btn btn-bet" id="betBtn" onclick="placeBet()">PLACE BET</button>
        <button class="main-btn btn-cashout" id="cashBtn" onclick="doCashout()">CASH OUT</button>
        
        <div class="menu-grid">
            <button class="m-btn m-dep" onclick="openAd('Deposit')">üì• Deposit</button>
            <button class="m-btn m-wit" onclick="openAd('Withdraw')">üì§ Withdraw</button>
            <button class="m-btn m-his" onclick="showHistory()">üìú History</button>
            <button class="m-btn m-set" onclick="showSettings()">‚öôÔ∏è Settings</button>
        </div>
    </div>

    <div id="adLayer" class="overlay">
        <h3 id="adText">Verifying Action...</h3>
        <iframe id="adFrame" style="width:100%; height:350px; border:none; background:#fff; border-radius:15px;"></iframe>
        <div style="margin-top:15px; font-size:18px;"><span id="sec">15</span>s left</div>
        <button id="skipBtn" style="display:none; margin-top:15px; padding:12px 30px; background:var(--green); border:none; border-radius:10px; font-weight:bold; color:white;" onclick="closeAd()">OPEN FORM</button>
    </div>

    <div id="popLayer" class="overlay">
        <div class="pop-card">
            <span class="close-pop" onclick="hidePop()">√ó</span>
            <div id="popContent"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const userId = tg.initDataUnsafe?.user?.id || "dev_user";
        const userName = tg.initDataUnsafe?.user?.first_name || "Guest";
        document.getElementById('uName').innerText = userName;

        const firebaseConfig = {
            apiKey: "AIzaSyBTu-63HAarfY0w2BZYFldwbPAxgIEIm8c",
            authDomain: "earn-pro-5d8a8.firebaseapp.com",
            projectId: "earn-pro-5d8a8",
            databaseURL: "https://earn-pro-5d8a8-default-rtdb.firebaseio.com/",
            storageBucket: "earn-pro-5d8a8.firebasestorage.app",
            messagingSenderId: "1090324824300",
            appId: "1:1090324824300:web:ce2815eee7837856fee5c9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let balance = 0, isBetOpen = true, isFlying = false, currentX = 1.00, hasCashedOut = false, activeBet = 0, activeTab = "";
        const ADS = ["https://otieu.com/4/10315373", "https://www.effectivegatecpm.com/e0xpfuhe?key=fb81fa455f0ff2d6a8fa09ce5d18dd57"];

        // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶°
        db.ref('users/' + userId).on('value', (snap) => {
            const data = snap.val();
            if (data) {
                balance = data.balance;
                document.getElementById('uBalance').innerText = balance.toLocaleString();
            } else {
                db.ref('users/' + userId).set({ balance: 5, name: userName }); 
            }
        });

        function startRound() {
            isBetOpen = true; isFlying = false; currentX = 1.00; hasCashedOut = false; activeBet = 0;
            document.getElementById('p-cont').style.display = 'none';
            document.getElementById('p-cont').style.left = "10%"; document.getElementById('p-cont').style.bottom = "30%";
            document.getElementById('p-img').innerText = "‚úàÔ∏è";
            document.getElementById('multiplier').innerText = "1.00x";
            document.getElementById('multiplier').style.color = 'var(--yellow)';
            document.getElementById('betBtn').style.display = 'block';
            document.getElementById('betBtn').disabled = false;
            document.getElementById('betBtn').innerText = "PLACE BET";
            document.getElementById('cashBtn').style.display = 'none';
            
            let wait = 10;
            let timer = setInterval(() => {
                document.getElementById('multiplier').innerText = wait + "s";
                document.getElementById('status').innerText = "TAKING BETS";
                wait--;
                if(wait < 0) { clearInterval(timer); launch(); }
            }, 1000);
        }

        function launch() {
            isBetOpen = false; isFlying = true;
            document.getElementById('p-cont').style.display = 'block';
            document.getElementById('multiplier').style.color = 'var(--green)';
            document.getElementById('status').innerText = "FLYING...";
            let x = 10, y = 30;
            let crashAt = (Math.random() * 4 + 1.1).toFixed(2);

            let loop = setInterval(() => {
                if(!isFlying) { clearInterval(loop); return; }
                currentX += 0.01;
                document.getElementById('multiplier').innerText = currentX.toFixed(2) + "x";
                
                if(!hasCashedOut && activeBet > 0) {
                    let liveProfit = (activeBet * currentX).toFixed(2);
                    document.getElementById('cashBtn').innerText = `CASH OUT (${liveProfit})`;
                }

                x += 0.2; y += 0.15;
                const pc = document.getElementById('p-cont');
                pc.style.left = x + "%"; pc.style.bottom = y + "%";
                const s = document.createElement('div'); s.className = 'smoke';
                pc.appendChild(s); setTimeout(() => s.remove(), 600);

                if(currentX >= crashAt) {
                    isFlying = false;
                    document.getElementById('p-img').innerText = "üí•";
                    document.getElementById('multiplier').style.color = 'var(--red)';
                    document.getElementById('status').innerText = "CRASHED!";
                    if(activeBet > 0 && !hasCashedOut) saveHistory("Loss", -activeBet);
                    setTimeout(startRound, 3000);
                }
            }, 100);
        }

        function placeBet() {
            const amt = parseFloat(document.getElementById('betAmt').value);
            if(!isBetOpen || isNaN(amt) || amt > balance || amt < 1) return tg.showAlert("Invalid Bet!");
            activeBet = amt;
            balance -= amt;
            db.ref('users/' + userId).update({ balance: balance });
            document.getElementById('betBtn').disabled = true;
            document.getElementById('betBtn').innerText = "BET PLACED";
            document.getElementById('cashBtn').style.display = 'block';
        }

        function doCashout() {
            if(!isFlying || hasCashedOut) return;
            hasCashedOut = true;
            let win = (activeBet * currentX).toFixed(2);
            balance += parseFloat(win);
            db.ref('users/' + userId).update({ balance: balance });
            saveHistory("Win", win);
            tg.showAlert(`Success! You won ${win} Pts`);
            document.getElementById('cashBtn').style.display = 'none';
        }

        function saveHistory(res, val) {
            db.ref('users/' + userId + '/history').push({ time: new Date().toLocaleTimeString(), res: res, val: val, x: currentX.toFixed(2) });
        }

        // AD & MODALS
        function openAd(type) {
            activeTab = type;
            document.getElementById('adFrame').src = ADS[Math.floor(Math.random()*ADS.length)];
            document.getElementById('adLayer').style.display = 'flex';
            let s = 15; document.getElementById('sec').innerText = s;
            document.getElementById('skipBtn').style.display = 'none';
            let t = setInterval(() => {
                s--; document.getElementById('sec').innerText = s;
                if(s <= 0) { clearInterval(t); document.getElementById('skipBtn').style.display = 'block'; }
            }, 1000);
        }

        function closeAd() {
            document.getElementById('adLayer').style.display = 'none';
            showForm();
        }

        function showForm() {
            const cont = document.getElementById('popContent');
            document.getElementById('popLayer').style.display = 'flex';
            if(activeTab === 'Deposit') {
                cont.innerHTML = `<h2 style="color:var(--blue)">Deposit Points</h2><p style="background:#3a3f47; padding:10px; border-radius:8px;">Send Money to: <b>01700000000</b></p>
                <select id="dm" class="input-box"><option>bKash</option><option>Nagad</option></select>
                <input type="number" id="da" class="input-box" placeholder="Amount (BDT)">
                <input type="number" id="dl" class="input-box" placeholder="Last 4 Digits">
                <button class="main-btn btn-bet" onclick="sendToAdmin('Deposit')">Submit Proof</button>`;
            } else {
                cont.innerHTML = `<h2 style="color:var(--red)">Withdraw Points</h2>
                <input type="number" id="wa" class="input-box" placeholder="Amount to Withdraw">
                <input type="text" id="wad" class="input-box" placeholder="Wallet Address / Number">
                <button class="main-btn m-wit" onclick="sendToAdmin('Withdraw')">Submit Request</button>`;
            }
        }

        function sendToAdmin(type) {
            let data = "";
            if(type === 'Deposit') {
                data = `Method: ${document.getElementById('dm').value}%0AAmount: ${document.getElementById('da').value}%0ALast 4: ${document.getElementById('dl').value}`;
            } else {
                data = `Points: ${document.getElementById('wa').value}%0AAddress: ${document.getElementById('wad').value}`;
            }
            
            // Render ‡¶è‡¶∞ Proxy ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã (Security)
            fetch(`/send-telegram?type=${type}&user=${userName}&data=${data}`)
            .then(res => {
                tg.showAlert("Request Submitted! Admin will verify soon.");
                hidePop();
            });
        }

        function hidePop() { document.getElementById('popLayer').style.display = 'none'; }

        function showHistory() {
            document.getElementById('popLayer').style.display = 'flex';
            const cont = document.getElementById('popContent');
            cont.innerHTML = `<h2>Game History</h2><div id="hList" style="text-align:left;"></div>`;
            db.ref('users/' + userId + '/history').limitToLast(8).once('value', s => {
                s.forEach(c => {
                    const d = c.val();
                    const color = d.res === 'Win' ? 'var(--green)' : 'var(--red)';
                    document.getElementById('hList').innerHTML += `<div style="border-bottom:1px solid #444; padding:10px; color:${color}">${d.time} | ${d.res}: ${d.val} Pts (${d.x}x)</div>`;
                });
            });
        }

        function showSettings() {
            document.getElementById('popLayer').style.display = 'flex';
            document.getElementById('popContent').innerHTML = `<h2>Settings</h2><p>User: ${userName}</p><p>ID: ${userId}</p><p>Server: Render High-Speed</p><p>Status: <span style="color:var(--green)">Online</span></p>`;
        }

        startRound();
    </script>
</body>
    </html>
