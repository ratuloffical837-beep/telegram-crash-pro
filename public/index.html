<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earn Pro Elite</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0b0e11; --card: #1e2329; --yellow: #f0b90b; --green: #02c076; --red: #f84960; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        .top-bar { background: var(--card); padding: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #333; }
        .game-area { height: 40vh; width: 100%; position: relative; background: #050709; display: flex; align-items: center; justify-content: center; }
        #multiplier { font-size: 60px; font-weight: bold; color: var(--green); }
        .controls { background: var(--card); padding: 20px; border-radius: 20px 20px 0 0; position: fixed; bottom: 0; width: 100%; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .m-btn { padding: 10px 0; font-size: 10px; color: white; border: none; border-radius: 5px; font-weight: bold; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #adFrame { width: 95%; height: 80%; background: white; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div>üë§ <span id="uName">...</span></div>
        <div style="color:var(--yellow)">üí∞ <span id="uBal">0.00</span></div>
    </div>
    <div class="game-area">
        <div id="multiplier">1.00x</div>
    </div>
    <div class="controls">
        <input type="number" id="betAmt" style="width:90%; padding:10px; margin-bottom:10px; background:#222; color:white; border:1px solid #444;" placeholder="Bet Amount">
        <button id="betBtn" class="btn" style="background:var(--green); color:white" onclick="placeBet()">PLACE BET</button>
        <button id="cashBtn" class="btn" style="background:var(--yellow); display:none;" onclick="cashOut()">CASH OUT</button>
        <div class="menu-grid">
            <button class="m-btn" style="background:#3262f1" onclick="showAd('Dep')">Deposit</button>
            <button class="m-btn" style="background:#f84960" onclick="showAd('Wit')">Withdraw</button>
            <button class="m-btn" style="background:#8a3ffc" onclick="showAd('His')">History</button>
            <button class="m-btn" style="background:orange" onclick="showAd('Ref')">Refer</button>
        </div>
        <button class="btn" style="background:var(--green); margin-top:10px; font-size:12px;" onclick="showAd('Task')">üéÅ DAILY TASK (10 TK)</button>
    </div>

    <div id="adOverlay" class="overlay">
        <div id="timer" style="font-size: 20px; color: var(--yellow); margin-bottom: 10px;">15s</div>
        <iframe id="adFrame"></iframe>
        <button id="skip" style="display:none; margin-top:15px; padding:12px 30px; background:var(--green); color:white; border:none; border-radius:8px;" onclick="finishAd()">CONTINUE</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const userId = tg.initDataUnsafe?.user?.id || "user_test";
        const userName = tg.initDataUnsafe?.user?.first_name || "Player";
        document.getElementById('uName').innerText = userName;

        const config = { databaseURL: "https://earn-pro-5d8a8-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(config);
        const db = firebase.database();

        let balance = 0, myBet = 0, cashed = false, taskCount = 0, currentAction = "";

        // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡ßã‡¶° (Firebase ‡¶•‡ßá‡¶ï‡ßá)
        db.ref('users/' + userId).on('value', s => {
            const d = s.val();
            if(d) { balance = d.balance; taskCount = d.taskCount || 0; document.getElementById('uBal').innerText = balance.toFixed(2); }
            else { db.ref('users/' + userId).set({balance: 5, taskCount: 0}); }
        });

        // ‡¶ó‡ßá‡¶Æ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï
        db.ref('game_state').on('value', s => {
            const state = s.val();
            const m = document.getElementById('multiplier');
            if(state.status === 'waiting') {
                m.innerText = state.timer + "s"; m.style.color = 'var(--yellow)';
                cashed = false; document.getElementById('betBtn').disabled = false;
            } else if(state.status === 'flying') {
                m.innerText = state.multiplier.toFixed(2) + "x"; m.style.color = 'var(--green)';
                if(myBet > 0 && !cashed) {
                    document.getElementById('betBtn').style.display = 'none';
                    document.getElementById('cashBtn').style.display = 'block';
                    document.getElementById('cashBtn').innerText = "CASH OUT ("+(myBet * state.multiplier).toFixed(2)+")";
                }
            } else {
                m.innerText = "üí• CRASHED"; m.style.color = 'var(--red)';
                document.getElementById('cashBtn').style.display = 'none';
                document.getElementById('betBtn').style.display = 'block'; myBet = 0;
            }
        });

        function showAd(action) {
            currentAction = action;
            document.getElementById('adFrame').src = "https://otieu.com/4/10315373";
            document.getElementById('adOverlay').style.display = 'flex';
            let s = 15;
            let t = setInterval(() => {
                s--; document.getElementById('timer').innerText = s + "s";
                if(s <= 0) { clearInterval(t); document.getElementById('skip').style.display = 'block'; }
            }, 1000);
        }

        function finishAd() {
            document.getElementById('adOverlay').style.display = 'none';
            document.getElementById('skip').style.display = 'none';
            if(currentAction === 'Task') {
                taskCount++;
                if(taskCount >= 40) { balance += 10; taskCount = 0; alert("Success! 10 TK added."); }
                db.ref('users/' + userId).update({balance: balance, taskCount: taskCount});
            } else {
                // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
                fetch(`/send-telegram?type=${currentAction}&details=User: ${userName}%0AID: ${userId}`);
                alert(currentAction + " request sent to admin!");
            }
        }

        function placeBet() {
            let a = parseFloat(document.getElementById('betAmt').value);
            if(a < 10 || a > balance) return alert("Low Balance!");
            myBet = a; balance -= a;
            db.ref('users/' + userId).update({balance: balance});
            document.getElementById('betBtn').disabled = true;
        }

        function cashOut() {
            if(cashed) return; cashed = true;
            db.ref('game_state/multiplier').once('value', s => {
                let win = myBet * s.val();
                balance += win;
                db.ref('users/' + userId).update({balance: balance});
                document.getElementById('cashBtn').style.display = 'none';
                document.getElementById('betBtn').style.display = 'block';
            });
        }
    </script>
</body>
</html>
